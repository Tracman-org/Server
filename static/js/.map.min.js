"use strict";let map,elevator,parsed_loc,setVehicleId,initial_followed_center,selected_vehicle;const markers={},map_element=document.getElementById("map"),socket=io("//"+window.location.hostname),IDLE_TIMEOUT=300;let _idleSecondsCounter=0;for(var i=0;i<mapData.vehicles.length;i++)mapData.vehicles[i].setter===userid&&(setVehicleId=mapData.vehicles[i].setter,console.log("Determined set vehicle as",setVehicleId)),mapData.vehicles[i]._id===mapData.settings.center.follow&&(initial_followed_center={lat:parseFloat(mapData.vehicles[i].last.lat)||0,lng:parseFloat(mapData.vehicles[i].last.lon)||0},console.log("Set initial followed center to",initial_followed_center));function resetIdleCounter(){_idleSecondsCounter=0,$("#inactive-mask").hide(),$("#inactive-message").hide()}function convertMeters(e){return console.log("convertMeters("+e+")"),"standard"===mapData.settings.units?(3.28084*e).toFixed():e.toFixed()}function initMap(){if("1"!==disp){if(map=new google.maps.Map(map_element,{center:"static"===mapData.settings.center.type?{lat:mapData.settings.center.lat,lng:mapData.settings.center.lon}:initial_followed_center,panControl:!!mapData.settings.canPan,scrollwheel:!!mapData.settings.canZoom,scaleControl:!!mapData.settings.showScale,draggable:!1,zoom:mapData.settings.defaultZoom||11,streetViewControl:!1,zoomControl:!!mapData.settings.canZoom,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:"sat"===mapData.settings.defaultMapType?google.maps.MapTypeId.HYBRID:google.maps.MapTypeId.ROADMAP}),mapData.vehicles.forEach(function(e){console.log("Creating marker for",e._id),markers[e._id]=new google.maps.Marker({position:{lat:e.last.lat,lng:e.last.lon},title:e.name,icon:e.marker?"/static/img/marker/"+e.marker+".png":"/static/img/marker/red.png",map:map,draggable:!1}),markers[e._id].addListener("click",function(){selected_vehicle=e._id,mapData.settings.showSpeed&&($("#spd").text(this.speed),$("spd-sign").show()),mapData.settings.showAlt&&($("#alt").text(this.altitude),$("#alt-sign").show()),mapData.settings.canPan&&map.setCenter(this.getPosition())})}),mapData.settings.canZoom&&map.addListener("zoom_changed",function(){map.setCenter(markers[mapData.settings.center.follow].getPosition())}),"0"!==noHeader&&"demo"!==mapData._id){const e=document.createElement("div");e.id="map-logo",e.innerHTML='<a href="https://www.tracman.org/"><img src="https://www.tracman.org/static/img/style/logo-28.png" alt="[]"><span class=\'text\'>Tracman</span></a>',map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(e)}const t=document.createElement("div");if(t.id="timestamp",mapData.lastUpdate&&(t.innerHTML="location updated "+new Date(mapData.lastUpdate).toLocaleString()),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(t),mapData.settings.showSpeed){const e=document.createElement("div"),t=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div");t.id="spd-label",t.innerHTML="SPEED",a.id="spd",1!==mapData.vehicles.length?e.style.display="none":a.innerHTML="standard"===mapData.settings.units?(2.23694*parseFloat(mapData.vehicles[0].last.spd)).toFixed():mapData.vehicles[0].last.spd.toFixed(),o.id="spd-unit",o.innerHTML="standard"===mapData.settings.units?"m.p.h.":"k.p.h.",e.id="spd-sign",e.appendChild(t),e.appendChild(a),e.appendChild(o),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(e)}if(mapData.settings.showAlt){elevator=new google.maps.ElevationService;const t=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div");a.id="alt-label",o.id="alt",n.id="alt-unit",t.id="alt-sign",a.innerHTML="ALTITUDE",1!==mapData.vehicles.length?t.style.display="hide":e(mapData.vehicles[0].last).then(function(e){o.innerHTML=convertMeters(e)}).catch(function(e){console.error("Could not load altitude from last known location: ",e),o.innerHTML="????"}),n.innerHTML="standard"===mapData.settings.units?"feet":"meters",t.appendChild(a),t.appendChild(o),t.appendChild(n),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(t)}}function e(e){return console.log("parseAlt("+e+"})"),new Promise(function(t,a){"number"==typeof e.alt?(console.log("Altitude was provided in loc as ",e.alt,"m"),t(e.alt)):(console.log("No altitude was provided in loc"),function(e){return new Promise(function(t,a){return(elevator=elevator||new google.maps.ElevationService).getElevationForLocations({locations:[{lat:e.lat,lng:e.lon}]},function(e,o,n){o===google.maps.ElevationStatus.OK&&e[0]?(console.log("Altitude was retrieved from Google Elevations API as",e[0].elevation,"m"),t(e[0].elevation)):a(Error(n))})})}(e).then(function(e){t(e)}).catch(function(e){a(e)}))})}function t(e){return{spd:"standard"===mapData.settings.units?2.23694*parseFloat(e.spd):parseFloat(e.spd),dir:parseFloat(e.dir),lat:parseFloat(e.lat),lon:parseFloat(e.lon),tim:new Date(e.tim).toLocaleString()}}function a(e){!function e(t,a,o){if(null==parsed_loc||t.tim===parsed_loc.tim){if(!n)var n=new google.maps.StreetViewService;n.getPanorama({location:{lat:t.lat,lng:t.lon},radius:a},function(n,s){switch(s){case google.maps.StreetViewStatus.OK:o(n);break;case google.maps.StreetViewStatus.ZERO_RESULTS:e(t,2*a,o);break;default:console.error(Error("Street view not available: "+s).message)}})}}(e,2,function(t){var a,o,n;$("#viewImg").attr("src","https://maps.googleapis.com/maps/api/streetview?size="+((n=$("#view")).width()<640&&n.height()<640?n.width().toFixed()+"x"+n.height().toFixed():n.width()>n.height()?"640x"+(640*n.height()/n.width()).toFixed():(640*n.width()/n.height()).toFixed()+"x640")+"&location="+t.location.latLng.lat()+","+t.location.latLng.lng()+"&fov=90&heading="+(e.spd>2?e.dir:String((a=e,o=t.location,90-Math.atan2(a.lat-o.latLng.lat(),a.lon-o.latLng.lng())*(180/Math.PI)%360)))+"&key="+mapKey)})}"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&a(t(mapData.vehicles[0].last)),socket.on("get",function(o){console.log("Got location:",o.lat+", "+o.lon+" for "+o.veh),parsed_loc=t(o),"1"!==disp&&(console.log("Setting vehicle",o.veh,"to",o.lat+",",o.lon+"..."),$("#timestamp").text("location updated "+parsed_loc.tim),google.maps.event.trigger(map,"resize"),markers[o.veh]&&markers[o.veh].setPosition({lat:parsed_loc.lat,lng:parsed_loc.lon}),"static"!==mapData.settings.center.type&&(selected_vehicle&&o.veh===selected_vehicle||!selected_vehicle&&o.veh===mapData.settings.center.follow)&&map.setCenter({lat:parsed_loc.lat,lng:parsed_loc.lon}),mapData.settings.showSpeed&&(markers[o.veh].speed=parsed_loc.spd.toFixed(),1!==mapData.vehicles.length&&selected_vehicle!==o.veh||$("#spd").text(parsed_loc.spd.toFixed())),mapData.settings.showAlt&&e(o).then(convertMeters).then(function(e){markers[o.veh].altitude=e,1!==mapData.vehicles.length&&selected_vehicle!==o.veh||$("#alt").text(e)}).catch(function(e){markers[o.veh].altitude=void 0,1!==mapData.vehicles.length&&selected_vehicle!==o.veh||$("#alt").text("????"),console.error(e.message)})),"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&a(parsed_loc)})}document.onclick=resetIdleCounter,document.onmousemove=resetIdleCounter,document.onkeypress=resetIdleCounter,window.setInterval(function(){_idleSecondsCounter>=300&&socket.connected?(console.log("Disconnecting because idle for more than",300,"seconds."),$("#inactive-mask").show(),$("#inactive-message").show(),socket.disconnect()):_idleSecondsCounter<=300&&!socket.connected&&(console.log("Reconnecting..."),socket.connect()),_idleSecondsCounter++},1e3),socket.on("connect",function(){console.log("Connected!"),socket.emit("can-get",mapData._id),setVehicleId&&socket.emit("can-set",userid,token)}),console.log("Disconnected!");