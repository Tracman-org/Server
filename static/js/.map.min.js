"use strict";let map,elevator,parsed_loc,setVehicleId,initial_followed_center;const markers={},map_element=document.getElementById("map"),socket=io("//"+window.location.hostname),IDLE_TIMEOUT=300;let _idleSecondsCounter=0;for(var i=0;i<mapData.vehicles.length;i++)mapData.vehicles[i].setter===userid&&(setVehicleId=mapData.vehicles[i].setter,console.log("Determined set vehicle as",setVehicleId)),mapData.vehicles[i]._id===mapData.settings.center.follow&&(initial_followed_center={lat:parseFloat(mapData.vehicles[i].last.lat)||0,lng:parseFloat(mapData.vehicles[i].last.lon)||0},console.log("Set initial followed center to",initial_followed_center));function resetIdleCounter(){_idleSecondsCounter=0,socket.connected||($("#inactive-mask").hide(),$("#inactive-message").hide())}function convertMeters(e){return console.log("convertMeters("+e+")"),"standard"===mapData.settings.units?(3.28084*e).toFixed():e.toFixed()}function initMap(){if("1"!==disp){if(map=new google.maps.Map(map_element,{center:"static"===mapData.settings.center.type?{lat:mapData.settings.center.lat,lng:mapData.settings.center.lon}:initial_followed_center,panControl:!!mapData.settings.canPan||!1,scrollwheel:!!mapData.settings.canZoom||!1,scaleControl:!!mapData.settings.showScale,draggable:!1,zoom:mapData.settings.defaultZoom||11,streetViewControl:!1,zoomControl:!!mapData.settings.canZoom,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:"sat"===mapData.settings.defaultMapType?google.maps.MapTypeId.HYBRID:google.maps.MapTypeId.ROADMAP}),mapData.vehicles.forEach(function(e){console.log("Creating marker for",e._id),markers[e._id]=new google.maps.Marker({position:{lat:e.last.lat,lng:e.last.lon},title:e.name,icon:e.marker?"/static/img/marker/"+e.marker+".png":"/static/img/marker/red.png",map:map,draggable:!1})}),mapData.settings.canZoom&&map.addListener("zoom_changed",function(){map.setCenter(markers[mapData.settings.center.follow].getPosition())}),"0"!==noHeader&&"demo"!==mapData._id){const e=document.createElement("div");e.id="map-logo",e.innerHTML='<a href="https://www.tracman.org/"><img src="https://www.tracman.org/static/img/style/logo-28.png" alt="[]"><span class=\'text\'>Tracman</span></a>',map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(e)}const e=document.createElement("div");if(e.id="timestamp",mapData.lastUpdate&&(e.innerHTML="location updated "+new Date(mapData.lastUpdate).toLocaleString()),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(e),mapData.settings.showSpeed){const e=document.createElement("div"),t=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div");t.id="spd-label",t.innerHTML="SPEED",o.id="spd",a.id="spd-unit",a.innerHTML="standard"===mapData.settings.units?"m.p.h.":"k.p.h.",e.id="spd-sign",e.appendChild(t),e.appendChild(o),e.appendChild(a),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(e)}if(mapData.settings.showAlt){elevator=new google.maps.ElevationService;const e=document.createElement("div"),t=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div");t.id="alt-label",o.id="alt",a.id="alt-unit",e.id="alt-sign",t.innerHTML="ALTITUDE",a.innerHTML="standard"===mapData.settings.units?"feet":"meters",e.appendChild(t),e.appendChild(o),e.appendChild(a),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(e)}}function e(e){return console.log("parseAlt("+e+"})"),new Promise(function(t,o){"number"==typeof e.alt?(console.log("Altitude was provided in loc as ",e.alt,"m"),t(e.alt)):(console.log("No altitude was provided in loc"),function(e){return new Promise(function(t,o){return(elevator=elevator||new google.maps.ElevationService).getElevationForLocations({locations:[{lat:e.lat,lng:e.lon}]},function(e,a,n){a===google.maps.ElevationStatus.OK&&e[0]?(console.log("Altitude was retrieved from Google Elevations API as",e[0].elevation,"m"),t(e[0].elevation)):o(Error(n))})})}(e).then(function(e){t(e)}).catch(function(e){o(e)}))})}function t(e){return{spd:"standard"===mapData.settings.units?2.23694*parseFloat(e.spd):parseFloat(e.spd),dir:parseFloat(e.dir),lat:parseFloat(e.lat),lon:parseFloat(e.lon),tim:new Date(e.tim).toLocaleString()}}function o(e){!function e(t,o,a){if(null==parsed_loc||t.tim===parsed_loc.tim){if(!n)var n=new google.maps.StreetViewService;n.getPanorama({location:{lat:t.lat,lng:t.lon},radius:o},function(n,l){switch(l){case google.maps.StreetViewStatus.OK:a(n);break;case google.maps.StreetViewStatus.ZERO_RESULTS:e(t,2*o,a);break;default:console.error(Error("Street view not available: "+l).message)}})}}(e,2,function(t){var o,a,n;$("#viewImg").attr("src","https://maps.googleapis.com/maps/api/streetview?size="+((n=$("#view")).width()<640&&n.height()<640?n.width().toFixed()+"x"+n.height().toFixed():n.width()>n.height()?"640x"+(640*n.height()/n.width()).toFixed():(640*n.width()/n.height()).toFixed()+"x640")+"&location="+t.location.latLng.lat()+","+t.location.latLng.lng()+"&fov=90&heading="+(e.spd>2?e.dir:String((o=e,a=t.location,90-Math.atan2(o.lat-a.latLng.lat(),o.lon-a.latLng.lng())*(180/Math.PI)%360)))+"&key="+mapKey)})}"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(t(mapData.vehicles[0].last)),socket.on("get",function(a){console.log("Got location:",a.lat+", "+a.lon+" for "+a.veh),parsed_loc=t(a),"1"!==disp&&(console.log("Updating map..."),$("#timestamp").text("location updated "+parsed_loc.tim),google.maps.event.trigger(map,"resize"),markers[a.veh].setPosition({lat:parsed_loc.lat,lng:parsed_loc.lon}),"static"!==mapData.settings.center.type&&a.veh===mapData.settings.center.follow&&map.setCenter({lat:parsed_loc.lat,lng:parsed_loc.lon}),mapData.settings.showSpeed&&1===mapData.vehicles.length&&$("#spd").text(parsed_loc.spd.toFixed()),mapData.settings.showAlt&&1===mapData.vehicles.length&&e(a).then(function(e){$("#alt").text(convertMeters(e))}).catch(function(e){$("#alt").text("????"),console.error(e.stack)})),"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(parsed_loc)})}document.onclick=resetIdleCounter,document.onmousemove=resetIdleCounter,document.onkeypress=resetIdleCounter,window.setInterval(function(){++_idleSecondsCounter>=300&&socket.connected?(console.log("Disconnecting because idle for more than",300,"seconds."),$("#inactive-mask").show(),$("#inactive-message").show(),socket.disconnect()):_idleSecondsCounter<=300&&!socket.connected&&console.log("Reconnecting..."),socket.connect()},1e3),socket.on("connect",function(){console.log("Connected!"),socket.emit("can-get",mapData._id),setVehicleId&&socket.emit("can-set",setVehicleId)}),console.log("Disconnected!"),$(function(){let e,t;$("#set-loc").click(function(){setVehicleId.length?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){const t={ts:Date.now(),tok:token,veh:setVehicleId,alt:e.coords.altitude,lat:e.coords.latitude,lon:e.coords.longitude,spd:e.coords.speed||0};socket.emit("set",t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to set location.")},{enableHighAccuracy:!0}):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#track-loc").click(function(){setVehicleId.length?navigator.geolocation?e?($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track').prop("title","Click here to track your location. "),navigator.geolocation.clearWatch(e),e=void 0):navigator.geolocation?($("#track-loc").html('<i class="fa fa-crosshairs fa-spin"></i>Stop').prop("title","Click here to stop tracking your location. "),e=navigator.geolocation.watchPosition(function(e){t={ts:Date.now(),tok:token,veh:setVehicleId,lat:e.coords.latitude,lon:e.coords.longitude,alt:e.coords.altitude,spd:e.coords.speed||0},socket.emit("set",t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to track location.")},{enableHighAccuracy:!0})):alert("Unable to track location. "):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#clear-loc").click(function(){setVehicleId.length?(e&&($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track'),navigator.geolocation.clearWatch(e),e=void 0),socket.emit("set",{ts:Date.now(),tok:token,veh:setVehicleId,lat:0,lon:0,spd:0}),console.log("Cleared location")):alert("You are not logged in! ")})});