"use strict";let map,elevator,parsed_loc,setVehicleId;const markers={},map_element=document.getElementById("map"),socket=io("//"+window.location.hostname),IDLE_TIMEOUT=10;let _idleSecondsCounter=0;for(var i=0;i<mapData.vehicles.length;i++)if(mapData.vehicles[i].setter===userid){setVehicleId=mapData.vehicles[i].setter;break}function resetIdleCounter(){_idleSecondsCounter=0,socket.connected||($("#inactive-mask").hide(),$("#inactive-message").hide())}function convertMeters(t){return console.log("convertMeters("+t+")"),"standard"===mapData.settings.units?(3.28084*t).toFixed():t.toFixed()}function initMap(){if("1"!==disp){if(mapData.vehicles.forEach(function(t){console.log("Creating marker for",t._id),markers[t._id]=new google.maps.Marker({position:{lat:t.last.lat,lng:t.last.lon},title:t.name,icon:(t.marker,t.marker+".png"),map:map,draggable:!1})}),map=new google.maps.Map(map_element,{center:"static"===mapData.settings.center.type?{lat:mapData.settings.center.lat,lng:mapData.settings.center.lon}:markers[mapData.settings.center.follow].getPosition(),panControl:!!mapData.settings.canPan||!1,scrollwheel:!!mapData.settings.canZoom||!1,scaleControl:!!mapData.settings.showScale,draggable:!1,zoom:mapData.settings.defaultZoom||11,streetViewControl:!1,zoomControl:!!mapData.settings.canZoom,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:"sat"===mapData.settings.defaultMapType?google.maps.MapTypeId.HYBRID:google.maps.MapTypeId.ROADMAP}),mapData.settings.canZoom&&map.addListener("zoom_changed",function(){map.setCenter(markers[mapData.settings.center.follow].getPosition())}),"0"!==noHeader&&"demo"!==mapData._id){const t=document.createElement("div");t.id="map-logo",t.innerHTML='<a href="https://www.tracman.org/"><img src="https://www.tracman.org/static/img/style/logo-28.png" alt="[]"><span class=\'text\'>Tracman</span></a>',map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(t)}const t=document.createElement("div");if(t.id="timestamp",mapData.lastUpdate&&(t.innerHTML="location updated "+new Date(mapData.lastUpdate).toLocaleString()),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(t),mapData.settings.showSpeed){const t=document.createElement("div"),e=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div");e.id="spd-label",e.innerHTML="SPEED",o.id="spd",a.id="spd-unit",a.innerHTML="standard"===mapData.settings.units?"m.p.h.":"k.p.h.",t.id="spd-sign",t.appendChild(e),t.appendChild(o),t.appendChild(a),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(t)}if(mapData.settings.showAlt){elevator=new google.maps.ElevationService;const t=document.createElement("div"),e=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div");e.id="alt-label",o.id="alt",a.id="alt-unit",t.id="alt-sign",e.innerHTML="ALTITUDE",a.innerHTML="standard"===mapData.settings.units?"feet":"meters",t.appendChild(e),t.appendChild(o),t.appendChild(a),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(t)}}function t(t){return console.log("parseAlt("+t+"})"),new Promise(function(e,o){"number"==typeof t.alt?(console.log("Altitude was provided in loc as ",t.alt,"m"),e(t.alt)):(console.log("No altitude was provided in loc"),function(t){return new Promise(function(e,o){return(elevator=elevator||new google.maps.ElevationService).getElevationForLocations({locations:[{lat:t.lat,lng:t.lon}]},function(t,a,n){a===google.maps.ElevationStatus.OK&&t[0]?(console.log("Altitude was retrieved from Google Elevations API as",t[0].elevation,"m"),e(t[0].elevation)):o(Error(n))})})}(t).then(function(t){e(t)}).catch(function(t){o(t)}))})}function e(t){return{spd:"standard"===mapData.settings.units?2.23694*parseFloat(t.spd):parseFloat(t.spd),dir:parseFloat(t.dir),lat:parseFloat(t.lat),lon:parseFloat(t.lon),tim:new Date(t.tim).toLocaleString()}}function o(t){!function t(e,o,a){if(null==parsed_loc||e.tim===parsed_loc.tim){if(!n)var n=new google.maps.StreetViewService;n.getPanorama({location:{lat:e.lat,lng:e.lon},radius:o},function(n,i){switch(i){case google.maps.StreetViewStatus.OK:a(n);break;case google.maps.StreetViewStatus.ZERO_RESULTS:t(e,2*o,a);break;default:console.error(Error("Street view not available: "+i).message)}})}}(t,2,function(e){var o,a,n;$("#viewImg").attr("src","https://maps.googleapis.com/maps/api/streetview?size="+((n=$("#view")).width()<640&&n.height()<640?n.width().toFixed()+"x"+n.height().toFixed():n.width()>n.height()?"640x"+(640*n.height()/n.width()).toFixed():(640*n.width()/n.height()).toFixed()+"x640")+"&location="+e.location.latLng.lat()+","+e.location.latLng.lng()+"&fov=90&heading="+(t.spd>2?t.dir:String((o=t,a=e.location,90-Math.atan2(o.lat-a.latLng.lat(),o.lon-a.latLng.lng())*(180/Math.PI)%360)))+"&key="+mapKey)})}"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(e(mapData.vehicles[0].last)),socket.on("get",function(a){console.log("Got location:",a.lat+", "+a.lon+" for "+a.veh),parsed_loc=e(a),"1"!==disp&&(console.log("Updating map..."),$("#timestamp").text("location updated "+parsed_loc.tim),google.maps.event.trigger(map,"resize"),markers[a.veh].setPosition({lat:parsed_loc.lat,lng:parsed_loc.lon}),"static"!==mapData.settings.center.type&&a.veh===mapData.settings.center.follow&&map.setCenter({lat:parsed_loc.lat,lng:parsed_loc.lon}),mapData.settings.showSpeed&&1===mapData.vehicles.length&&$("#spd").text(parsed_loc.spd.toFixed()),mapData.settings.showAlt&&1===mapData.vehicles.length&&t(a).then(function(t){$("#alt").text(convertMeters(t))}).catch(function(t){$("#alt").text("????"),console.error(t.stack)})),"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(parsed_loc)})}document.onclick=resetIdleCounter,document.onmousemove=resetIdleCounter,document.onkeypress=resetIdleCounter,window.setInterval(function(){++_idleSecondsCounter>=10&&socket.connected?(console.log("Disconnecting because idle for more than",10,"seconds."),$("#inactive-mask").show(),$("#inactive-message").show(),socket.disconnect()):_idleSecondsCounter<=10&&!socket.connected&&console.log("Reconnecting..."),socket.connect()},1e3),socket.on("connect",function(){console.log("Connected!"),socket.emit("can-get",mapData._id),setVehicleId&&socket.emit("can-set",setVehicleId)}),console.log("Disconnected!"),$(function(){let t,e;$("#set-loc").click(function(){setVehicleId.length?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){const e={ts:Date.now(),tok:token,veh:setVehicleId,alt:t.coords.altitude,lat:t.coords.latitude,lon:t.coords.longitude,spd:t.coords.speed||0};socket.emit("set",e),console.log("Set location:",e.lat+", "+e.lon)},function(t){alert("Unable to set location.")},{enableHighAccuracy:!0}):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#track-loc").click(function(){setVehicleId.length?navigator.geolocation?t?($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track').prop("title","Click here to track your location. "),navigator.geolocation.clearWatch(t),t=void 0):navigator.geolocation?($("#track-loc").html('<i class="fa fa-crosshairs fa-spin"></i>Stop').prop("title","Click here to stop tracking your location. "),t=navigator.geolocation.watchPosition(function(t){e={ts:Date.now(),tok:token,veh:setVehicleId,lat:t.coords.latitude,lon:t.coords.longitude,alt:t.coords.altitude,spd:t.coords.speed||0},socket.emit("set",e),console.log("Set location:",e.lat+", "+e.lon)},function(t){alert("Unable to track location.")},{enableHighAccuracy:!0})):alert("Unable to track location. "):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#clear-loc").click(function(){setVehicleId.length?(t&&($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track'),navigator.geolocation.clearWatch(t),t=void 0),socket.emit("set",{ts:Date.now(),tok:token,veh:setVehicleId,lat:0,lon:0,spd:0}),console.log("Cleared location")):alert("You are not logged in! ")})});