"use strict";let map,elevator,newLoc;const markers={},mapElem=document.getElementById("map"),socket=io("//"+window.location.hostname),IDLE_TIMEOUT=300;let _idleSecondsCounter=0;function resetIdleSecondsCounter(){_idleSecondsCounter=0}function metersToFeet(e){return"standard"===mapData.settings.units?(3.28084*e).toFixed():e.toFixed()}function initMap(){if("1"!==disp){if(map=new google.maps.Map(mapElem,{center:{lat:mapData.vehicles.length>1?mapData.settings.defaultMap.lat:mapData.vehicles[0].last.lat,lng:mapData.vehicles.length>1?mapData.settings.defaultMap.lon:mapData.vehicles[0].last.lon},panControl:!1,scrollwheel:1===mapData.vehicles.length,scaleControl:!!mapData.settings.showScale,draggable:!1,zoom:mapData.settings.defaultMap.zoom,streetViewControl:!1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:"sat"===mapData.settings.defaultMap.type?google.maps.MapTypeId.HYBRID:google.maps.MapTypeId.ROADMAP}),mapData.vehicles.forEach(function(e){void 0===e._id&&(e._id=e.id),markers[e._id]=new google.maps.Marker({position:{lat:e.last.lat,lng:e.last.lon},title:e.name,icon:e.marker?"/static/img/marker/"+e.marker+".png":"/static/img/marker/red.png",map:map,draggable:!1})}),1===Object.keys(markers).length&&map.addListener("zoom_changed",function(){map.setCenter(markers[Object.keys(markers)[0]].getPosition())}),"0"!==noHeader&&"demo"!==mapData._id){const e=document.createElement("div");e.id="map-logo",e.innerHTML='<a href="https://www.tracman.org/"><img src="https://www.tracman.org/static/img/style/logo-28.png" alt="[]"><span class=\'text\'>Tracman</span></a>',map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(e)}const t=document.createElement("div");if(t.id="timestamp",mapData.lastUpdate&&(t.innerHTML="location updated "+new Date(mapData.lastUpdate).toLocaleString()),map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(t),mapData.settings.showSpeed&&1===mapData.vehicles.length){const e=document.createElement("div"),t=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div");t.id="spd-label",t.innerHTML="SPEED",o.id="spd",o.innerHTML="standard"===mapData.settings.units?(2.23694*parseFloat(mapData.vehicles[0].last.spd)).toFixed():mapData.vehicles[0].last.spd.toFixed(),a.id="spd-unit",a.innerHTML="standard"===mapData.settings.units?"m.p.h.":"k.p.h.",e.id="spd-sign",e.appendChild(t),e.appendChild(o),e.appendChild(a),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(e)}if(mapData.settings.showAlt&&1===mapData.vehicles.length){elevator=new google.maps.ElevationService;const t=document.createElement("div"),o=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div");o.id="alt-label",a.id="alt",n.id="alt-unit",t.id="alt-sign",a.innerHTML="",o.innerHTML="ALTITUDE",e(mapData.vehicles[0].last).then(function(e){a.innerHTML=metersToFeet(e)}).catch(function(e){console.error("Could not load altitude from last known location: ",e)}),n.innerHTML="standard"===mapData.settings.units?"feet":"meters",t.appendChild(o),t.appendChild(a),t.appendChild(n),map.controls[google.maps.ControlPosition.TOP_RIGHT].push(t)}}function e(e){return new Promise(function(t,o){"number"==typeof e.alt?(console.log("Altitude was provided in loc as ",e.alt,"m"),t(e.alt)):(console.log("No altitude was provided in loc"),function(e){return new Promise(function(t,o){return(elevator=elevator||new google.maps.ElevationService).getElevationForLocations({locations:[{lat:e.lat,lng:e.lon}]},function(e,a,n){a===google.maps.ElevationStatus.OK&&e[0]?(console.log("Altitude was retrieved from Google Elevations API as",e[0].elevation,"m"),t(e[0].elevation)):o(Error(n))})})}(e).then(function(e){t(e)}).catch(function(e){o(e)}))})}function t(e){return e.spd="standard"===mapData.settings.units?2.23694*parseFloat(e.spd):parseFloat(e.spd),e.dir=parseFloat(e.dir),e.lat=parseFloat(e.lat),e.lon=parseFloat(e.lon),e.tim=new Date(e.tim).toLocaleString(),e}function o(e){!function e(t,o,a){if(null==newLoc||t.tim===newLoc.tim){if(!n)var n=new google.maps.StreetViewService;n.getPanorama({location:{lat:t.lat,lng:t.lon},radius:o},function(n,i){switch(i){case google.maps.StreetViewStatus.OK:a(n);break;case google.maps.StreetViewStatus.ZERO_RESULTS:e(t,2*o,a);break;default:console.error(Error("Street view not available: "+i).message)}})}}(e,2,function(t){var o,a,n;$("#viewImg").attr("src","https://maps.googleapis.com/maps/api/streetview?size="+((n=$("#view")).width()<640&&n.height()<640?n.width().toFixed()+"x"+n.height().toFixed():n.width()>n.height()?"640x"+(640*n.height()/n.width()).toFixed():(640*n.width()/n.height()).toFixed()+"x640")+"&location="+t.location.latLng.lat()+","+t.location.latLng.lng()+"&fov=90&heading="+(e.spd>2?e.dir:String((o=e,a=t.location,90-Math.atan2(o.lat-a.latLng.lat(),o.lon-a.latLng.lng())*(180/Math.PI)%360)))+"&key="+mapKey)})}"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(t(mapData.vehicles[0].last)),socket.on("get",function(a){console.log("Got location:",a.lat+", "+a.lon+" for "+a.veh),newLoc=t(a),"1"!==disp&&($("#timestamp").text("location updated "+newLoc.tim),google.maps.event.trigger(map,"resize"),markers[a.veh].setPosition({lat:newLoc.lat,lng:newLoc.lon}),1===mapData.vehicles.length&&map.setCenter({lat:newLoc.lat,lng:newLoc.lon}),mapData.settings.showSpeed&&1===mapData.vehicles.length&&$("#spd").text(newLoc.spd.toFixed()),mapData.settings.showAlt&&1===mapData.vehicles.length&&e(a).then(function(e){$("#alt").text(metersToFeet(e))}).catch(function(e){$("#alt").text("????"),console.error(e.stack)})),"0"!==disp&&mapData.settings.showStreetview&&1===mapData.vehicles.length&&o(newLoc)})}document.onclick=resetIdleSecondsCounter,document.onmousemove=resetIdleSecondsCounter,document.onkeypress=resetIdleSecondsCounter,window.setInterval(function(){++_idleSecondsCounter>=300?socket.connected&&(console.log("Disconnecting because idle for more than",300,"seconds."),$("#inactive-mask").show(),$("#inactive-message").show(),socket.disconnect()):socket.connected||(console.log("Reconnecting the user because they are no longer idle."),$("#inactive-mask").hide(),$("#inactive-message").hide(),socket.connect())},1e3),socket.on("connect",function(){console.log("Connected!"),socket.emit("can-get",mapData._id),setVehicleId&&socket.emit("can-set",setVehicleId)}).on("disconnect",function(){console.log("Disconnected!")}).on("error",function(e){console.error(e)}),$(function(){let e,t;$("#set-loc").click(function(){setVehicleId.length?navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){const t={ts:Date.now(),tok:token,veh:setVehicleId,alt:e.coords.altitude,lat:e.coords.latitude,lon:e.coords.longitude,spd:e.coords.speed||0};socket.emit("set",t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to set location."),console.error(e.stack)},{enableHighAccuracy:!0}):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#track-loc").click(function(){setVehicleId.length?navigator.geolocation?e?($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track').prop("title","Click here to track your location. "),navigator.geolocation.clearWatch(e),e=void 0):navigator.geolocation?($("#track-loc").html('<i class="fa fa-crosshairs fa-spin"></i>Stop').prop("title","Click here to stop tracking your location. "),e=navigator.geolocation.watchPosition(function(e){t={ts:Date.now(),tok:token,veh:setVehicleId,lat:e.coords.latitude,lon:e.coords.longitude,alt:e.coords.altitude,spd:e.coords.speed||0},socket.emit("set",t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to track location."),console.error(e.stack)},{enableHighAccuracy:!0})):alert("Unable to track location. "):alert("Geolocation not enabled. "):alert("You are not logged in! ")}),$("#clear-loc").click(function(){setVehicleId.length?(e&&($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track'),navigator.geolocation.clearWatch(e),e=void 0),socket.emit("set",{ts:Date.now(),tok:token,veh:setVehicleId,lat:0,lon:0,spd:0}),console.log("Cleared location")):alert("You are not logged in! ")})});