"use strict"
function resetIdleSecondsCounter(){_idleSecondsCounter=0}function metersToFeet(e){return"standard"===mapuser.settings.units?(3.28084*e).toFixed():e.toFixed()}function toggleMaps(e){0===e.lat&&0===e.lon?($("#map").hide(),$("#view").hide(),$("#notset").show()):($("#map").show(),$("#view").show(),$("#notset").hide())}function initMap(e){function t(t){return new Promise(function(o,n){return elevator=elevator||new e.ElevationService,elevator.getElevationForLocations({locations:[{lat:t.lat,lng:t.lon}]},function(t,a,i){a===e.ElevationStatus.OK&&t[0]?(console.log("Altitude was retrieved from Google Elevations API as",t[0].elevation,"m"),o(t[0].elevation)):n(Error(i))})})}function o(e){return new Promise(function(o,n){"number"==typeof e.alt?(console.log("Altitude was provided in loc as ",e.alt,"m"),o(e.alt)):(console.log("No altitude was provided in loc"),t(e).then(function(e){o(e)}).catch(function(e){n(e)}))})}function n(e){return e.spd="standard"===mapuser.settings.units?2.23694*parseFloat(e.spd):parseFloat(e.spd),e.dir=parseFloat(e.dir),e.lat=parseFloat(e.lat),e.lon=parseFloat(e.lon),e.tim=new Date(e.tim).toLocaleString(),e}function a(t,o,n){if(null==newLoc||t.tim===newLoc.tim){if(!i)var i=new e.StreetViewService
i.getPanorama({location:{lat:t.lat,lng:t.lon},radius:o},function(i,s){switch(s){case e.StreetViewStatus.OK:n(i)
break
case e.StreetViewStatus.ZERO_RESULTS:a(t,2*o,n)
break
default:console.error(new Error("Street view not available: "+s).message)}})}}function i(e){function t(e,t){return 90-Math.atan2(e.lat-t.latLng.lat(),e.lon-t.latLng.lng())*(180/Math.PI)%360}function o(e){return e.width()<640&&e.height()<640?e.width().toFixed()+"x"+e.height().toFixed():e.width()>e.height()?"640x"+(640*e.height()/e.width()).toFixed():(640*e.width()/e.height()).toFixed()+"x640"}a(e,2,function(n){$("#viewImg").attr("src","https://maps.googleapis.com/maps/api/streetview?size="+o($("#view"))+"&location="+n.location.latLng.lat()+","+n.location.latLng.lng()+"&fov=90&heading="+(e.spd>2?e.dir:String(t(e,n.location)))+"&key="+mapKey)})}if("1"!==disp){if(map=new e.Map(mapElem,{center:{lat:mapuser.last.lat,lng:mapuser.last.lon},panControl:!1,scrollwheel:!0,scaleControl:!!mapuser.settings.showScale,draggable:!1,zoom:mapuser.settings.defaultZoom,streetViewControl:!1,zoomControlOptions:{position:e.ControlPosition.LEFT_TOP},mapTypeId:"road"===mapuser.settings.defaultMap?e.MapTypeId.ROADMAP:e.MapTypeId.HYBRID}),marker=new e.Marker({position:{lat:mapuser.last.lat,lng:mapuser.last.lon},title:mapuser.name,icon:mapuser.settings.marker?"/static/img/marker/"+mapuser.settings.marker+".png":"/static/img/marker/red.png",map:map,draggable:!1}),map.addListener("zoom_changed",function(){map.setCenter(marker.getPosition())}),"0"!==noHeader&&"demo"!==mapuser._id){const s=document.createElement("div")
s.id="map-logo",s.innerHTML='<a href="https://www.tracman.org/"><img src="https://www.tracman.org/static/img/style/logo-28.png" alt="[]"><span class=\'text\'>Tracman</span></a>',map.controls[e.ControlPosition.BOTTOM_LEFT].push(s)}const r=document.createElement("div")
if(r.id="timestamp",mapuser.last.time&&(r.innerHTML="location updated "+new Date(mapuser.last.time).toLocaleString()),map.controls[e.ControlPosition.RIGHT_BOTTOM].push(r),mapuser.settings.showSpeed){const l=document.createElement("div"),c=document.createElement("div"),d=document.createElement("div"),u=document.createElement("div")
c.id="spd-label",c.innerHTML="SPEED",d.id="spd",d.innerHTML="standard"===mapuser.settings.units?(2.23694*parseFloat(mapuser.last.spd)).toFixed():mapuser.last.spd.toFixed(),u.id="spd-unit",u.innerHTML="standard"===mapuser.settings.units?"m.p.h.":"k.p.h.",l.id="spd-sign",l.appendChild(c),l.appendChild(d),l.appendChild(u),map.controls[e.ControlPosition.TOP_RIGHT].push(l)}if(mapuser.settings.showAlt){elevator=new e.ElevationService
const p=document.createElement("div"),m=document.createElement("div"),g=document.createElement("div"),h=document.createElement("div")
m.id="alt-label",g.id="alt",h.id="alt-unit",p.id="alt-sign",g.innerHTML="",m.innerHTML="ALTITUDE",o(mapuser.last).then(function(e){g.innerHTML=metersToFeet(e)}).catch(function(e){console.error("Could not load altitude from last known location: ",e)}),h.innerHTML="standard"===mapuser.settings.units?"feet":"meters",p.appendChild(m),p.appendChild(g),p.appendChild(h),map.controls[e.ControlPosition.TOP_RIGHT].push(p)}}"0"!==disp&&mapuser.settings.showStreetview&&i(n(mapuser.last)),socket.on("get",function(t){console.log("Got location:",t.lat+", "+t.lon),newLoc=n(t),"1"!==disp&&($("#timestamp").text("location updated "+newLoc.tim),e.event.trigger(map,"resize"),map.setCenter({lat:newLoc.lat,lng:newLoc.lon}),marker.setPosition({lat:newLoc.lat,lng:newLoc.lon}),mapuser.settings.showSpeed&&$("#spd").text(newLoc.spd.toFixed()),mapuser.settings.showAlt&&o(t).then(function(e){$("#alt").text(metersToFeet(e))}).catch(function(e){$("#alt").text("????"),console.error(e.stack)})),"0"!==disp&&mapuser.settings.showStreetview&&i(newLoc)})}var map,marker,elevator,newLoc
const mapElem=document.getElementById("map"),socket=io("//"+window.location.hostname),IDLE_TIMEOUT=300
var _idleSecondsCounter=0
document.onclick=resetIdleSecondsCounter,document.onmousemove=resetIdleSecondsCounter,document.onkeypress=resetIdleSecondsCounter,window.setInterval(function(){_idleSecondsCounter++,_idleSecondsCounter>=300?socket.connected&&(console.log("Disconnecting because idle for more than",300,"seconds."),socket.disconnect()):socket.connected||(console.log("Reconnecting the user because they are no longer idle."),socket.connect())},1e3),socket.on("connect",function(){console.log("Connected!"),socket.emit("can-get",mapuser._id),mapuser._id===userid&&socket.emit("can-set",userid)}).on("disconnect",function(){console.log("Disconnected!")}).on("error",function(e){console.error(e.stack)}),$(function(){toggleMaps(mapuser.last)
var e,t
$("#set-loc").click(function(){!userid===mapuser._id?alert("You are not logged in! "):navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t={ts:Date.now(),tok:token,usr:userid,alt:e.coords.altitude,lat:e.coords.latitude,lon:e.coords.longitude,spd:e.coords.speed||0}
socket.emit("set",t),toggleMaps(t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to set location."),console.error(e.stack)},{enableHighAccuracy:!0}):alert("Geolocation not enabled. ")}),$("#track-loc").click(function(){!userid===mapuser._id?alert("You are not logged in! "):e?($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track').prop("title","Click here to track your location. "),navigator.geolocation.clearWatch(e),e=void 0):navigator.geolocation?($("#track-loc").html('<i class="fa fa-crosshairs fa-spin"></i>Stop').prop("title","Click here to stop tracking your location. "),e=navigator.geolocation.watchPosition(function(e){t={ts:Date.now(),tok:token,usr:userid,lat:e.coords.latitude,lon:e.coords.longitude,alt:e.coords.altitude,spd:e.coords.speed||0},socket.emit("set",t),toggleMaps(t),console.log("Set location:",t.lat+", "+t.lon)},function(e){alert("Unable to track location."),console.error(e.stack)},{enableHighAccuracy:!0})):alert("Unable to track location. ")}),$("#clear-loc").click(function(){!userid===mapuser._id?alert("You are not logged in! "):(e&&($("#track-loc").html('<i class="fa fa-crosshairs"></i>Track'),navigator.geolocation.clearWatch(e),e=void 0),t={ts:Date.now(),tok:token,usr:userid,lat:0,lon:0,spd:0},socket.emit("set",t),toggleMaps(t),console.log("Cleared location"))})})
